# ERA - 适用于云计算的经济资源分配框架

## 摘要

从系统的角度来看，云计算已经非常成熟了，但目前所部署的解决方案所采用的经济机制相当初级，因此导致硬件资源的分配并未达到最佳标准，而这些资源是非常昂贵的。

本文中，我们提出了ERA，一个用于调度和计价云资源的完整框架，旨在基于经济准则来分配资源，从而提高云资源使用的效率。ERA架构细致地抽象了底层的云基础设施使得调度和定价算法的开发独立于具体的底层云基础设施和这些基础设施所关注的问题。具体来说，我们将ERA设计为的灵活的一层，可以配置于任何云系统的上层，也可以配置于这些接口的上层——给云资源管理者的接口，和给用户（这些用户预留资源来运行他们的作业）的接口。作业是根据预期需求动态计算的价格来调度排定的。此外，ERA为可插拔的算法模块提供了一个关键的内部应用程序接口，这些模块涵盖调度、定价和需求预测。我们提供了原型软件，通过将其部署在公有云和私有云上进行测试，具体包括Azure Batch of Microsoft和Hadoop/YARN，证明了该架构的有效性。


我们一个更长远的想法是，促进经济学和系统社区之间的协作。为此，我们开发了一个仿真平台，通过这个平台，经济学专家和系统专家可以测试他们的算法实现。


## 关键词
云计算；经济；动态定价；预定

## 1. 介绍
云计算，不管是私有云还是公有云，在业界都是实现高投资回报比的范例，这是通过共享庞大的计算基础设施实现的，而建造和操作这些基础设施的成本很高[5,14]。高效的共享中枢围绕着两个关键要素：1）能够安全高效地复用一系列硬件资源，为不同用户提供服务的一套系统基础设施；以及2）在多个用户的资源需求发生冲突时可以进行仲裁的经济机制。

最先进的云产品提供上述两方面的解决方案，但不同程度上都具有一定的复杂性。系统方面的挑战一直受到广泛研究，重点是时空复用。空间复用包括在租户之间共享服务器，其安全性由虚拟机[34,32,7]和容器技术[23,22]保障。时间复用包括一系列根据时间排定任务的技术和系统。从严格支持服务水平目标（SLO）[10,17,30,11]，到最大化集群利用[12,35,18,25,24,13,8]，都是研究的重点。其中许多进展已经在公有云[26,4]和私有云[1,31,15,33,8]上部署了解决方案。这表明在云端如何解决系统挑战已相对成熟。另一方面，尽管在最近的研究中经济挑战收到了一些关注（见[27,16,6,28,19,20]和其中的引用）,但这些基本经济准则尚未转化为实践中可行的解决方案。


### 1.1 经济挑战和ERA的方法

在现有的云环境中，资源分配由相当初级的经济机制运作。第一种机制（常见于私有云[31,8,15,33]）使用预先支付的固定保障配额。第二种（常见于公有云[26,4]）使用按需单位价格：用户为其使用的每一单位资源支付实实在在的金钱（或者，在公司内部支付法定货币）。在大多数情况下，这些都是固定价格，而值得注意的一个例外是亚马逊的动态定价的现货实例。（尽管根据独立分析来看，甚至这些现货实例也并非真正利用市场机制来确定价格[3]。）但是，现货实例产品没有提供保障服务，以至于如果用户出价太低，这些实例可能被销毁。因此，用户在购买使用现货实例时，需要特别关注竞价，还需要考虑到可能不太适用于一些高优先级的生产作业[21,28,2]。最根本的问题是，我们需要找到一个能够高效实现预期的高产出的定价和调度方案。

***效率***：从经济学的角度来看，云系统最基本的目标是最大化经济效益，即最大化所有的用户从系统中获得的价值总和。例如，当两个用户有需求冲突时，其中改变任务运行时间、地点甚至取消任务所付出的代价更低的那位用户，应当在此次冲突中让步——切换至备选方案。资源将被分配给具有“最高边际价值”的用户。对于一个给定的云，最理想的分配方案的基准是，有一个“无所不知”的调度器：有权访问所有用户的所有信息，这些信息包括他们的内部成本和替代方案；有权以一种能够最大化云所有者的效益的方式，决定将什么资源分配给什么人。再次强调：要获得有意义的效益衡量，我们必须计算获得的价值而非使用的资源，而且我们应该将最大化这一基于价值理念的效益作为目标。（当然，另一个重要目标是收益，但是我们注意到潜在收益受限于创造的价值，因此取得高效益是获得高收益所需要的。此外，由于云服务提供商之间存在竞争，这些提供商通常着眼于提高短期效益，因为这可能会产生正面的长期收益效应。在提供高水平服务的“平台即服务”（PaaS）中，增加收益的讨论通常被指责。本质上这与分配效益是正交的，超出了本文的范畴。）

***当前解决方案的局限性***：秉持着基于价值的效益理念，我们评估了常见的被部署应用的计价机制。私有云框架[31,8,15,33]，典型地依靠预先支付的保障性配额。这种方案的主要问题是：形式上，没有提供真正的公用资源共享——为了保证每位用户总是能获得可用的预付费的保障性资源，云系统实际上必须保持充足的资源，以满足其所允诺的负载总和，尽管在任一时刻可能只有一小部分资源被使用。类似这种“工作保留 公平排队”[12]的机制，通常为提高利用率而设计，但是他们没有在根本上改变基于价值的效益方程，因为超出用户配额提供的资源通常没有分布式开销，也没有保障。此外，一次性预付费说明用户使用他们的受保障的资源的边际成本本质上是零，因此不管他们有没有做“有用”的作业来充分利用资源，他们都倾向于使用这部分资源来做一些“无用”的作业。这经常导致云系统看似满载运行，从工程的每个角度看都是如此，但从经济的角度来看，因为大多数时间的大多数作业价值非常低，所以整个系统实际上是运转在一个非常“低生产力”的状态中的。

另一方面，公有云产品[26,4]通常使用按需单位定价机制。这一解放方案的问题在于，资源的可用性无法提前保障。通常，需求是“尖峰”的：短时高频需求散布于长时低频需求之中。这样尖峰的需求在其他共享基础设施的领域也很典型，例如计算机网络带宽、电力系统、滑雪度假区等。所有这些案例中，共享资源的提供商都面临这样一个两难情境：是提供极其昂贵的容载冗余供应，还是放弃高峰期的保障性服务？在这些云系统中，对于足够重要的作业，用户无法承担作业不能运行的风险，导致按需定价只适合低价值或者时间高度灵活的作业，而大多时间不灵活的重要生产作业仰仗于购买长期的保障性资源权限。尽管灵活的单位价格（例如亚马逊的现货实例）可能比固定单价有优势，因为前者可以在时间上平滑需求，但如前文所强调，前者仅仅有机会服务于典型的低价值非生产作业。

***ERA的方法***：我们在ERA中提供的定价模型可以实现资源共享和需求平滑，对于高价值的生产作业也不例外。这是通过预定来实现的，这一理念众所周知，常用于酒店的房间或超级计算机的时间、还有一些云系统[10,17,30]等众多类型的资源。但我们的预定，在定价和调度方面都以一种灵活的方式实现。我们专注于调度和定价批处理风格的计算所面临的经济挑战，这些计算在共享的云基础设施上是能完全满足时间水平服务目标（即截止日期这一关键指标）的。呈现给用户的基本模型是资源预定。在“预定的时间”，用户程序指定预定请求。这种请求的基本形式是：（请求的一般形式是由ERA的“竞价描述语言”（见2.3.2）给出的，竞价描述语言允许指定多项资源、有关资源使用的随时间变化的变量“shapes”，及其组合）

>基本预定：我需要100个容器（每个容器有6GB的内存和2个CPU核心），5个小时，今天6:00到18:00之间的某个时间段，我最多愿意付100美元。

这类工作负荷非常突出，许多“大数据”就属于这个类别[11,30,17]。而且这为我们提供了一个进行经济调查研究的独特机会。尽管最先进的解决方案为资源共享提供了高效的系统级机制，这些方案仍然依赖于用户能够出于好心，向系统完全真实地说明他们的资源需求和截止日期。ERA的机制确保用户支付的最终价格是系统为授予请求所能提供的最低价格。用户的灵活性越高，用户获得理想价格的机会就越大。如果这个最低价格超过了用户愿意支付的最高价格，那么请求将会被回绝。（或者，ERA的机制可以将这个最低价格作为“报价”呈现给用户，用户可以决定是接受还是拒绝）一旦预定请求被接受，在预定时间内所需付款金额是固定的，用户可以确信在所请求的时间窗口内，他所预定的资源是可用的。这一保证是满足请求，而不是对特定时间的特定资源提供承诺。有关向用户提供的模型的更多细节，参见第2.3.1节。

### 1.2 ERA总览
制定一个优秀的云资源分配方案这一挑战中的关键部分是云资源的多面性：虽然我们的目标是在比较高层次的经济层面，但是必须直接在计算机系统工程层面进行具体实现。我们必须使用巧妙的算法连接这极为不同的两个视角，并使用合适的软件工程来实现。事实上，在关于云系统的文献中，可以看到许多论文分别解决这些方面的其中一方面，包括“系统”的论文以及关于在云系统中调度和定价作业的理论的论文。遗憾的是，文献中这些不同的思路常常不能彼此联结，也很难组合成一个整体的方案。我们认为在这一点上的一个关键挑战是提供一个包含所有这些考虑因素的共同抽象。我们称之为架构挑战。


我们应对这一挑战的答案就是ERA系统（经济资源分配）。我们将ERA系统设计为云用户和底层云基础设施之间的中间层。ERA提供了一个单一模型，涵盖了云系统底层所有内容各异的关键问题：经济的、算法的、系统级的和人机接口的等等。ERA旨在通过经济原则的方式指导云系统的资源分配决策，从而将经济学见解实际上集成到现实世界的系统基础设施中。（并非云上的所有资源都必须由ERA管理。云也可能让ERA只管理所有资源的一个子集（允许系统进行增量测试），或者将有几个ERA的实例来管理资源的不同子集。）这是通过关键架构抽象实现的：ERA的云接口，隐藏了资源管理基础设施的许多细节，使ERA几乎能够独立于底层云基础设施来应对经济挑战。ERA满足三个关键设计目标：1）提供了一个清晰的理论抽象，能够进行更正式的研究；2）是一个实用的端到端软件系统；3）为扩展性而设计，所有的算法都易于演进和实验。

***ERA的关键应用程序接口***：ERA有两个主要面向外部的应用程序接口，以及一个关键的内部应用程序接口。图1给出了ERA架构的高级示意图。第一个外部应用程序接口面向用户，并为他们提供上述云服务的经济预定模型。第二个外部应用程序接口面向低级云资源管理者，对其所关注的问题进行解耦，将基础云系统从任何时间相关的调度或定价问题中解放出来，并且让ERA系统不用承担：以合理的资源区域分配方式，将指定的处理器分配给指定的任务；低级别的进程启动、进程交换机制。更多细节见第2.3节。

最后，内部应用程序接口是可插拔的调度、定价和预测算法模块。我们的基本调度和定价算法根据供需情况动态计算未来的资源价格，其中需求既包括已经提交确认的资源，也包括所预测的未来请求的资源，并尽可能以最低价对当前需求进行计划和定价。我们的基本预测模型使用历史的运行记录来估计未来的需求。于是，这一灵活的算法应用程序接口易于进行算法、学习和经济方面的优化。第3节介绍了内部接口以及我们的基本算法实现。

我们定义这种抽象的目标，比ERA系统中单纯的软件工程更为深远。为了促进融合系统和经济两方面的考虑，我们还构建了灵活的云仿真框架。仿真器提供关键指标的评估，包括负载或延迟等“系统指标”以及福利或收益等“经济指标”，并提供结果可视化（见图2中的截屏）。该仿真器旨在为云系统管理人员和研究人员提供便利的工具。云系统管理人员可能想要评估ERA的性能，以作为实现系统整合应用的一个步骤；研究人员为ERA开发新算法，想要在不运行大型集群的情况下测试他们的实现。如图1所示，接收真实用户请求并通过底层云资源管理器运行的核心代码，可以连接到仿真器而不是真实用户，这就方便在不同负载和备选云模型下对其进行测试。通过比较我们的仿真器和物理集群运行的结果，我们发现仿真器是可信的（第4节）。

ERA系统是用Java实现的，而用C#写的一个替代实现（ERA的一个子集）也已经完成。我们在仿真器中对ERA做了大量的运行测试，以及在公有云和私有云中使用两个优秀的资源管理器进行了原型软件运行测试：整个系统与Hadoop/YARN[31]进行接口交互，C#版本的代码与微软的Azure Batch仿真器（Azure Batch是一种云规模的作业调度和计算管理服务。 `https://azure.microsoft.com/en-us/services/batch/`）进行交互，并在上面测试。这些运行测试表明ERA算法能够成功提高云的使用效率，并且ERA是可以成功整合到真实的云系统中的。另外，我们证明了ERA仿真器可以很好地近似真实系统上的实际运行状况，因此可以作为开发和测试新算法的有用工具。在第4节中，我们将介绍这些运行的其中一些结果。



***贡献***：总而言之，我们提出了ERA，一个用于定价和调度，且满足全时段服务水平目标的预定系统。ERA做出了如下贡献：
1. 我们提出了一个抽象和系统架构，使我们能处理与底层云基础设施相关的经济挑战。
2. 我们设计了算法用于调度和定价达到服务水平目标的批处理作业，以及预测资源需求。
3. 我们设计了一个可靠的云仿真器，系统专家和经济专家可以通过它研究和测试算法实现。
4. 我们将ERA和两个云基础设施集成在一起，并通过实验展示了其有效性。

## 2. ERA的模型和架构
### 2.1 使用动态价格的竞价预定模型
ERA旨在处理云系统的一组计算资源，如核心和内存，其目标是高效地将这些资源分配给用户。其基本思想是，用户可以对所需资源进行预定，以在将来某个时间点运行作业。并且，一旦接受预订，就可以保证这些资源（尽可能地）是在所预定的时间内可用的。对所预定资源的可用性保证，使得高价值的作业可以像预付费保证配额模型那样使用云，而无需购买整个容量（对所有时段），因此，ERA也允许资源的时间共享，这增加了效益。

这些资源的价格作为预定的时间内的报价，并根据（算法估计的）需求和供应变化动态计算。用户在时间方面越灵活，则可以自动获得越低的价格。基本思想就是这些动态价格将调节需求，更好地利用云资源。这种机制还可以确保在高峰时期——需求根本无法满足——运行的作业是最有价值的，而不是任意的。ERA使用一种简单的竞价模型，用户在每个作业请求中附加一个货币值，指定用户愿意为运行该作业而支付的最大金额。不能适应高峰期的作业所损失的价值，可作为购买额外云资源所能获得的价值的量化，这将是云服务提供商采购决策流程的重要参照指标。

### 2.2 云模型
【2018.03.12凌晨 实在翻不动了，先审前面的，我继续翻后面的】
ERA框架中的云

### 2.3 ERA的架构

#### 2.3.1 ERA与用户之间的接口

***竞价描述语言***

***makeReservation方法***

#### 2.3.2 ERA与云端的接口

***getCurrentAllocation方法***

***getCurrentAllocation方法***

**update方法（可选使用）**

## 3. 算法

### 3.1 调度和定价算法接口

***基本经济调度***

### 3.2 需求预测接口

**基于数据的预测器：基于历史数据的预测**

## 4. ERA系统和仿真

***经济分配的重要性***

***ERA-Rayon的集成***

***测试Azure Batch***

## 5. 巨大的挑战

### 5.1 作业调度

### 5.2 定价

### 5.3 学习

### 5.4 鲁棒性


## 引用

